// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatar    String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  PREMIUM
}

// Authentication and sessions
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              AccountType
  provider          String
  providerAccountId String?
  accessToken       String
  refreshToken      String?
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("accounts")
}

enum AccountType {
  OAUTH
  EMAIL
  API_KEY
}

// Presentations
model Presentation {
  id          String   @id @default(cuid())
  title       String
  description String?
  userId      String
  templateId  String?
  status      PresentationStatus @default(DRAFT)
  data        Json?    // Store canvas state, elements, etc.
  settings    Json?    // Canvas settings, theme, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  slides      Slide[]
  exports     Export[]

  @@map("presentations")
}

enum PresentationStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  PROCESSING
}

// Slides within presentations
model Slide {
  id             String   @id @default(cuid())
  presentationId String
  order          Int
  title          String
  content        Json?    // Rich text content, elements, etc.
  background     Json?    // Background settings
  transitions    Json?    // Animation settings
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)
  elements       Element[]

  @@map("slides")
}

// Elements within slides
model Element {
  id           String   @id @default(cuid())
  slideId      String
  type         ElementType
  content      Json     // Element data, position, style, etc.
  zIndex       Int      @default(0)
  locked       Boolean  @default(false)
  visible      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  slide        Slide    @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@map("elements")
}

enum ElementType {
  TEXT
  SHAPE
  IMAGE
  DRAWING
  CHART
  VIDEO
}

// Templates
model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  thumbnail   String
  data        Json      // Template structure, elements, etc.
  tags        String[]
  isPublic    Boolean  @default(false)
  downloads   Int      @default(0)
  rating      Float    @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("templates")
}

// Collaboration
model Collaboration {
  id            String   @id @default(cuid())
  presentationId String
  userId        String
  role          CollaborationRole @default(VIEWER)
  permissions    Json      // Specific permissions for this user
  joinedAt       DateTime @default(now())
  lastActiveAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("collaborations")
}

enum CollaborationRole {
  OWNER
  EDITOR
  VIEWER
  COMMENTER
}

// Real-time presence
model Presence {
  id           String   @id @default(cuid())
  userId       String
  presentationId String?
  socketId    String
  cursor       Json?    // Cursor position, selection, etc.
  status       UserStatus @default(ACTIVE)
  lastSeen     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("presence")
}

enum UserStatus {
  ACTIVE
  IDLE
  AWAY
  BUSY
}

// File storage metadata
model StorageFile {
  id           String   @id @default(cuid())
  originalName String
  filename     String
  mimeType     String
  size         Int
  url          String
  key          String   // S3 key
  bucket       String
  region       String
  uploadedBy   String
  isPublic     Boolean  @default(false)
  downloads    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  entry       String @default("files")

  @@map("storage_files")
}

// AI generation logs
model AIGeneration {
  id           String   @id @default(cuid())
  userId       String?
  prompt       String
  model        String
  response     Json     // AI response data
  tokens       Int      // Token usage
  cost         Float    // API cost
  latency      Int      // Response time in ms
  status       GenerationStatus @default(PENDING)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("ai_generations")
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Queue jobs
model QueueJob {
  id           String   @id @default(cuid())
  type         JobType
  data         Json      // Job payload
  priority     JobPriority @default(NORMAL)
  status       JobStatus @default(QUEUED)
  attempts     Int      @default(0)
  maxAttempts  Int      @default(3)
  scheduledAt  DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("queue_jobs")
}

enum JobType {
  PRESENTATION_PROCESSING
  IMAGE_GENERATION
  CONTENT_GENERATION
  EMAIL_SENDING
  SEARCH_INDEXING
}

enum JobPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Search index
model SearchIndex {
  id           String   @id @default(cuid())
  entityType   String   // 'template', 'presentation', 'user', etc.
  entityId     String
  content      Json      // Searchable content
  keywords     String[]
  weight       Float    @default(1.0)
  indexedAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("search_indices")
}

// Analytics and metrics
model Analytics {
  id           String   @id @default(cuid())
  userId       String?
  event        AnalyticsEvent
  properties   Json      // Event properties
  value        Float?   // Event value
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  @@map("analytics")
}

// Export models
model Export {
  id             String   @id @default(cuid())
  presentationId String
  format         String
  options        Json
  fileSize       Int
  downloadUrl    String
  expiresAt      DateTime
  processingTime Int
  status         ExportStatus @default(COMPLETED)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@map("exports")
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AnalyticsEvent {
  PRESENTATION_CREATED
  PRESENTATION_UPDATED
  PRESENTATION_DELETED
  PRESENTATION_SHARED
  TEMPLATE_USED
  AI_GENERATION_REQUESTED
  AI_GENERATION_COMPLETED
  USER_LOGIN
  USER_LOGOUT
  COLLABORATION_STARTED
  COLLABORATION_ENDED
  FILE_UPLOADED
  SEARCH_PERFORMED
  ERROR_OCCURRED
}
